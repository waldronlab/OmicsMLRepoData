---
title: "ETL: data dictionary of cMD metadata"
author:
  - Sehyun Oh
date: "`r format(Sys.time(), '%B %d, %Y')`"
format:
    html:
        fontsize: 14pxs
        toc: true
        top-depth: 3
abstract: "Extract, Transform, and Load (ETL): We introduce ontology terms into cMD sampleMetadata. This updated cMD sampleMetadata attributes are summarized here as cMD data dictionary"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE,
                      collapse = TRUE)
```

```{r echo=FALSE}
suppressPackageStartupMessages({
    library(dplyr)
})
```

```{r echo=FALSE}
## [Update needed] to get data files directly from the GH repo
dir <- "~/OmicsMLRepo/OmicsMLRepoData/curatedMetagenomicData"
```

The `merging_schema` table shows the original and curated fields of the cMD 
`sampleMetadata` table.

```{r merging_schema}
## Merging_schema table from Google Drive
url <- "https://docs.google.com/spreadsheets/d/1xziFB_zBl32BjNarcyEN4GupTYpPtq5aDz0GbRbWvtk/edit?usp=sharing"
ss <- googledrive::as_id(url)
merging_schema <- googlesheets4::read_sheet(ss = ss, sheet = "merging_schema")

## Names of the original fields
old_fields <- sapply(merging_schema$original_fields, strsplit, split = ";") %>% 
    unlist %>% 
    as.character
old_fields[!is.na(old_fields)]

## Names of the new fields
new_fields <- sapply(merging_schema$curated_fields, strsplit, split = ";") %>% 
    unlist %>% 
    as.character
new_fields
```


# Build a schema for curated fields
## Age
- [Feature Request] Conditional requirement?
- Use dynamic enums for age_unit (NCIT:C50400)?
```{r}
source(file.path(dir, "R/template_age.R"))
curated_age_all
```

## study_condition
- [Todo] Compare 'disease_stage' column with that of cBioPortalData
- [Feature Request] Adopt dynamic enums?
```{r}
source(file.path(dir, "R/template_condition.R"))
curated_disease_all
```

## treatment
```{r}
source(file.path(dir, "R/template_treatment.R"))
curated_treatment
```

## bodysite
- [Feature Request] Use the same dictionary for both bodysite and bodysubsite?   
- [Feature Request] Adopt dynamic enums?
```{r}
source(file.path(dir, "R/template_bodysite.R"))
curated_bodysite
curated_bodysubsite
```


## Others
`sex` and `antibiotics_current_use`
```{r}
source(file.path(dir, "R/template_others.R"))
curated_sex
curated_abx_current_use
```


# Save
Combine data schema for all the curated attributes
```{r}
curated_all <- do.call("rbind", list(curated_age_all, 
                                     curated_disease_all, 
                                     curated_treatment,
                                     curated_bodysite,
                                     curated_bodysubsite,
                                     curated_sex,
                                     curated_abx_current_use))
```

```{r save_data_dictionary, eval=FALSE}
## Save for GitHub
write.csv(curated_all, "~/OmicsMLRepo/OmicsMLRepoData/inst/extdata/cMD_data_dictionary.csv", row.names = FALSE)

## Export to Google Sheet
url <- "https://docs.google.com/spreadsheets/d/1xziFB_zBl32BjNarcyEN4GupTYpPtq5aDz0GbRbWvtk/edit?usp=sharing"
ss <- googledrive::as_id(url)
googlesheets4::sheet_write(curated_all, ss = ss, sheet = "data_dictionary")
```


# Sucession plan
We will update original column names by adding prefix (e.g., `legacy_`) to them.
```{r}
## Load cMD curation template
ori <- read.csv("https://raw.githubusercontent.com/waldronlab/curatedMetagenomicDataCuration/master/inst/extdata/template.csv")

## Add empty ontology column and `legacy_` prefix
legacy_ind <- which(ori$col.name %in% old_fields)
ori$col.name[legacy_ind] <- paste0("legacy_", ori$col.name[legacy_ind])
ori$ontology <- NA
formated_ori <- rbind(ori[-legacy_ind,], ori[legacy_ind,]) # 'legacy_' fields at the end

updated <- rbind(curated_all, formated_ori)
id_row_ind <- which(updated$col.name %in% c("study_name", "sample_id", "subject_id"))
updated <- rbind(updated[id_row_ind,], updated[-id_row_ind,])
sum(duplicated(updated$col.name)) # should be 0
```

The `updated` table has the 'original' columns at the end with the `legacy_` prefix.
```{r eval=FALSE}
## Save for GitHub
write.csv(updated, "~/OmicsMLRepo/OmicsMLRepoData/inst/extdata/cMD_data_dictionary_all.csv", row.names = FALSE)

## Export to Google Sheet
url <- "https://docs.google.com/spreadsheets/d/1xziFB_zBl32BjNarcyEN4GupTYpPtq5aDz0GbRbWvtk/edit?usp=sharing"
ss <- googledrive::as_id(url)
googlesheets4::sheet_write(updated, ss = ss, sheet = "data_dictionary_all")
```


